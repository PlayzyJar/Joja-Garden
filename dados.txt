class TestLeituraAdmin:
    

    def test_ler_admin_nao_encontrado(self, client: TestClient):
        header = get_admin_header(client)
        admin_id_inexistente = 99999 
        
        response = client.get(f"/admin/{admin_id_inexistente}", headers=header)
        
        assert response.status_code == status.HTTP_404_NOT_FOUND
        assert "Administrador não encontrado" in response.json()["detail"]

class TestAlterarSenhaAdmin:
    # A rota espera os 'dados' (AlterarSenha) no corpo da requisição e o {admin_id} na URL. 
    # Analisando a rota: `router.put("/{admin_id}/alterar-senha", ...)`
    # O current_admin é o admin logado, e ele muda a senha dele mesmo se o ID na URL for o dele.

    def setup_method(self, client: TestClient):
        # Garante a criação do admin e retorna o header para reuso
        self.header = get_admin_header(client)
        # Pega o ID do admin logado
        login = {"username": admin_valido["cpf"], "password": admin_valido["senha"]}
        response = client.post("/auth/token", data=login)
        token = response.json()["access_token"]
        
        # Com o token, buscamos o admin logado (assumindo que há uma rota de usuário logado ou decodificamos o token)
        # Para simplificar, vou buscar o admin recém-criado pelo CPF
        # Nota: Idealmente, o ID viria de uma rota de 'meu perfil' ou do token.
        from main.models.user import Admin # Importe Admin no seu arquivo de testes, se necessário
        
        # **Atenção:** Você precisará de um `session` no seu `setup_method` ou passar ele como fixture.
        # Como estamos limitados ao `client` do fastapi.testclient, vamos simplificar.
        # Vamos assumir que o Admin criado em `get_admin_header` é o Admin 1. 
        # Esta é uma **simplificação perigosa**, mas necessária sem acesso direto ao DB na fixture.

    def test_alterar_senha_sucesso(self, client: TestClient, db_session: Session):
        # 1. Cria e autentica o admin
        header = get_admin_header(client)
        # 2. Busca o ID do Admin logado (Admin Valido)
        admin_logado = db_session.query(Super_usuario).filter(Super_usuario.cpf == admin_valido['cpf']).first()
        admin_id = admin_logado.id

        dados_alteracao = {
            "senha_atual": admin_valido["senha"],
            "nova_senha": "NovaSenhaSegura123!", # Senha nova e válida
        }
        
        response = client.put(f"/admin/{admin_id}/alterar-senha", headers=header, json=dados_alteracao)
        
        assert response.status_code == status.HTTP_200_OK
        assert "A senha foi alterada com sucesso" in response.json()["msg"]

    def test_alterar_senha_atual_incorreta(self, client: TestClient, db_session: Session):
        header = get_admin_header(client)
        admin_logado = db_session.query(Super_usuario).filter(Super_usuario.cpf == admin_valido['cpf']).first()
        admin_id = admin_logado.id

        dados_alteracao = {
            "senha_atual": "SenhaErrada!", # Senha atual incorreta (MISSING)
            "nova_senha": "NovaSenhaSegura123!",
        }
        
        response = client.put(f"/admin/{admin_id}/alterar-senha", headers=header, json=dados_alteracao)
        
        assert response.status_code == status.HTTP_400_BAD_REQUEST
        assert "A senha atual está incorreta" in response.json()["detail"]

    def test_alterar_senha_nova_igual_a_atual(self, client: TestClient, db_session: Session):
        header = get_admin_header(client)
        admin_logado = db_session.query(Super_usuario).filter(Super_usuario.cpf == admin_valido['cpf']).first()
        admin_id = admin_logado.id

        dados_alteracao = {
            "senha_atual": admin_valido["senha"],
            "nova_senha": admin_valido["senha"], # Nova senha igual à atual (MISSING)
        }
        
        response = client.put(f"/admin/{admin_id}/alterar-senha", headers=header, json=dados_alteracao)
        
        assert response.status_code == status.HTTP_400_BAD_REQUEST
        assert "A nova senha deve ser diferente da atual" in response.json()["detail"]

    def test_alterar_senha_nova_senha_invalida(self, client: TestClient, db_session: Session):
        header = get_admin_header(client)
        admin_logado = db_session.query(Super_usuario).filter(Super_usuario.cpf == admin_valido['cpf']).first()
        admin_id = admin_logado.id

        dados_alteracao = {
            "senha_atual": admin_valido["senha"],
            "nova_senha": "curta", # Nova senha inválida (MISSING)
        }
        
        response = client.put(f"/admin/{admin_id}/alterar-senha", headers=header, json=dados_alteracao)
        
        assert response.status_code == status.HTTP_400_BAD_REQUEST
        assert "Senha inválida" in response.json()["detail"]

class TestDeletarAdmin:
    def test_deletar_admin_sucesso(self, client: TestClient, db_session: Session):
        # 1. Cria e autentica o admin logado (deletador)
        admin_deletador_header = get_admin_header(client)

        # 2. Cria um segundo admin para ser deletado
        admin_a_deletar = {
            "nome": "Admin para Deletar",
            'cpf': "11111111111",
            "senha": "SenhaDeletar123@",
        }
        response_cria = client.post("admin/criar_conta", json=admin_a_deletar)
        admin_id_deletar = response_cria.json()["id"]

        # 3. Deleta o segundo admin
        response = client.delete(f"/admin/{admin_id_deletar}", headers=admin_deletador_header)

        assert response.status_code == status.HTTP_200_OK
        assert f"Administrador {admin_a_deletar['nome']} foi deletado por outro Administrador." in response.json()["message"]
        
        # Verifica se o admin foi realmente deletado (opcional, mas bom)
        response_leitura = client.get(f"/admin/{admin_id_deletar}", headers=admin_deletador_header)
        assert response_leitura.status_code == status.HTTP_404_NOT_FOUND

    def test_deletar_admin_nao_encontrado(self, client: TestClient):
        header = get_admin_header(client)
        admin_id_inexistente = 99999 # Um ID que certamente não existe (MISSING)

        response = client.delete(f"/admin/{admin_id_inexistente}", headers=header)

        assert response.status_code == status.HTTP_404_NOT_FOUND
        assert f"Administrador com ID {admin_id_inexistente} não encontrado." in response.json()["detail"]

    def test_admin_tentar_se_auto_deletar(self, client: TestClient, db_session: Session):
        header = get_admin_header(client)
        
        # Encontra o ID do admin logado (Admin Valido)
        admin_logado = db_session.query(Super_usuario).filter(Super_usuario.cpf == admin_valido['cpf']).first()
        admin_id_logado = admin_logado.id # O admin logado tenta deletar a si mesmo (MISSING)

        response = client.delete(f"/admin/{admin_id_logado}", headers=header)

        assert response.status_code == status.HTTP_400_BAD_REQUEST
        assert "Não é permitido que um administrador se auto-delete." in response.json()["detail"]